# Presigned URL Debug Mode

## Problem

Presigned URLs generated by the Lambda function are returning `SignatureDoesNotMatch` errors when accessed.

## Debug Solution

A debug mode has been added to the Lambda function that bypasses the Adobe/Knock conversion and creates a dummy file. This allows testing the S3 upload and presigned URL generation without consuming Adobe licenses.

## How to Use

### 1. Deploy the Updated Lambda

```bash
cd infrastructure
pulumi up
```

### 2. Run the Debug Test

```bash
cd tests
python test_presigned_url.py
```

Or invoke directly with curl:

```bash
# Get the function URL
FUNCTION_URL=$(cd infrastructure && pulumi stack output function_url)

# Invoke with debug mode
curl -X POST "$FUNCTION_URL" \
  -H "Content-Type: application/json" \
  -d '{"debug": true, "filename": "MyTestFile"}'
```

### 3. Analyze the Results

The test will:

1. ✅ Invoke the Lambda in debug mode
2. ✅ Create a dummy file and upload to S3
3. ✅ Generate a presigned URL
4. ✅ Attempt to download the file
5. ✅ Display success or detailed error information

## Debug Mode Parameters

```json
{
  "debug": true, // Enable debug mode (required)
  "filename": "TestFile" // Optional: custom filename
}
```

Alternative parameter names that work:

- `"debug_mode": true`
- `"test_mode": true`

## What Changed

### 1. Lambda Handler (`infrastructure/lambda/handler.py`)

- Added debug mode detection
- Creates a dummy `.epub` file with test content
- Uses the same S3 upload logic as real conversions
- Enhanced logging for presigned URL generation

### 2. S3 Upload Function (`_handle_s3_output`)

- Removed public ACL (keeps bucket private)
- Explicit region configuration
- Better error handling and logging
- Uses `ClientMethod` parameter explicitly

### 3. Infrastructure (`infrastructure/__main__.py`)

- Reverted public bucket changes
- Bucket remains private with default permissions

## Expected Output

**Successful test:**

```json
{
  "message": "Conversion successful",
  "output_files": [
    {
      "filename": "Test_File.epub",
      "s3_key": "converted/Test_File.epub",
      "download_url": "https://...",
      "size_bytes": 123
    }
  ],
  "stdout": "Debug mode - no actual conversion performed"
}
```

## Troubleshooting

### If presigned URL still fails:

1. **Check CloudWatch Logs** for detailed error messages
2. **Verify AWS Region** matches in all configurations
3. **Check IAM permissions** on the Lambda role
4. **Verify system time** is accurate (AWS signature validation)
5. **Try different expiration times** (currently 1 hour)

### Common Issues

- **SignatureDoesNotMatch**: Usually credentials or time sync
- **AccessDenied**: IAM permissions issue
- **NoSuchBucket**: Bucket name or region mismatch
- **InvalidRequest**: Malformed presigned URL parameters

## Next Steps

Once the presigned URL works in debug mode, the same logic will work for real ACSM conversions.
